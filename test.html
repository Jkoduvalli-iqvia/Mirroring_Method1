<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <title>GitLab Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <header class="flex items-center justify-between px-8 py-4 bg-white shadow">
        <img src="/static/iqvia_logo.png" alt="IQVIA" class="h-10">
        <h1 class="text-2xl font-bold">Gitlab Dashboard</h1>
        <input type="search" placeholder="Search..." class="border rounded px-2 py-1 w-1/4">
    </header>

    <main class="max-w-screen-xl mx-auto mt-8 px-4">
        <section class="grid grid-cols-12 gap-6">
            <aside class="col-span-2">
                <!-- Optionally Sidebar nav or left space -->
            </aside>
            <div class="col-span-10 space-y-6">

                <!-- User and Project Summary -->
                <div class="flex space-x-12">
                    <div class="bg-blue-100 p-4 rounded-lg flex space-x-4 items-center">
                        <div class="text-blue-600 font-bold">
                            <p>Active Users: <span id="active-users">Loading...</span></p>
                            <p>Deactivated Users: <span id="deactivated-users">Loading...</span></p>
                            <p>Blocked Users: <span id="blocked-users">Loading...</span></p>
                            <p>Total Users: <span id="total-users">Loading...</span></p>
                        </div>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg flex space-x-4 items-center">
                        <div class="text-red-600 font-bold">
                            <p>Active Projects: <span id="active-projects">Loading...</span></p>
                            <p>Archived Projects: <span id="archived-projects">Loading...</span></p>
                            <p>Total Projects: <span id="total-projects">Loading...</span></p>
                        </div>
                    </div>
                </div>

                <!-- Contribution Chart -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-semibold text-xl">Contribution</h2>
                        <button onclick="expandSection('contribution')" class="text-blue-600">Expand</button>
                        <button onclick="downloadCSV('users_summary')" class="text-green-600">Download</button>
                    </div>
                    <canvas id="contributionChart" height="100"></canvas>
                </div>

                <!-- Additional cards like login trend, languages etc. would be added here similarly -->

            </div>
        </section>
    </main>

<script>
    async function fetchSummary() {
        const resp = await fetch('/api/users_summary');
        const data = await resp.json();
        document.getElementById('active-users').textContent = data.active_users;
        document.getElementById('deactivated-users').textContent = data.deactivated_users;
        document.getElementById('blocked-users').textContent = data.blocked_users;
        document.getElementById('total-users').textContent = data.total_users;

        const projectResp = await fetch('/api/projects_summary');
        const projectData = await projectResp.json();
        document.getElementById('active-projects').textContent = projectData.active_projects;
        document.getElementById('archived-projects').textContent = projectData.archived_projects;
        document.getElementById('total-projects').textContent = projectData.total_projects;
    }

    async function loadContributionChart() {
        const resp = await fetch('/api/contribution_trend');
        const data = await resp.json();

        new Chart(document.getElementById('contributionChart'), {
            type: 'line',
            data: {
                labels: data.dates,
                datasets: [{
                    label: 'Commits',
                    data: data.counts,
                    borderColor: 'rgb(37, 99, 235)',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            }
        });
    }

    function downloadCSV(name) {
        window.location.href = '/download/' + name + '.csv';
    }

    function expandSection(name) {
      alert("Expand Modal for " + name + " not implemented yet."); // Replace with modal logic
    }

    window.onload = () => {
        fetchSummary();
        loadContributionChart();
    };
</script>
</body>
</html>
